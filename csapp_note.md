

# 深入理解计算机操作系统 学习笔记

# 第1章  计算机系统漫游

## 1 编译系统

### 1.1 编译系统执行过程

包括预处理、编译、汇编、链接四个阶段。

这里面以一个hello word程序简单说明上述过程。

hello.c文件程序

```c
#include <stdio.h>

int main(){

    printf(” h e l l o , world ”);

    return 0;

}
```



预处理：替换掉以#开头的内容替换掉源程序，简单理解就是文本替换，hello.c 经过预处理变成hello.i文件。

编译    ：这一阶段主要是语法分析、语义分析、词法分析、中间代码生成及优化等，将程序翻译成汇编程序，

​               hello.i文件变成hello.s文件。

汇编    ：将汇编程序翻译成机器指令，hello.s 变成可重定位目标文件hello.o。

链接    ：将hello.o 和 printf.o链接合并得到可执行文件hello。

### 1.2 理解编译系统的好处

（1）优化程序性能

（2）理解链接过程出现的错误

（3）避免安全漏洞

## 2 系统硬件架构

系统硬件主要包括CPU、内存、总线、I/O设备。

![csapp_1_1](C:\Users\lenovo\Desktop\CSAPP\csapp_note\pictures\csapp_1_1.PNG)

### 2.1 CPU

CPU主要由PC（程序计数器）、寄存器堆、算术/逻辑单元（ALU）组成。

PC：是一个4字节或者8字节的存储空间，存放的是某一条指令的地址，处理器不断地执行PC指向的指令

寄存器：用于临时存放数据，例如计算a + b, 从内存读取a存放在寄存器X中，读取b存放与寄存器Y中。

ALU:  进行算数与逻辑的计算，计算机核心部分，计算速度极快。

### 2.2 内存

内存主要存放程序指令以及数据，可以看成一个从零开始的大数组，每个字节都有相应地址.

### 2.3 总线

总线负责系统各个部件之间的数据传递，比如处理器和内存、I/O设备和处理器、I/O设备和内存。

### 2.4 I/O设备

包括鼠标、键盘、显示器、磁盘等，通过控制器或者适配器与I/O总线相连。

## 3 解释内存中的指令

以hello程序为例，可执行目标文件**hello** 已经存放在系统的磁盘上，如何运行这个可执行文件呢？

1. 通过键盘输入”./hello” 的字符串，shell 程序会将输入的字符逐一读入寄存器，处理器会把**hello** 这个字符串放入内存中。


2. 按下回车键时，shell程序执行一系列的指令来来加载可执行文件**hello**。
3. 利用DMA（Direct Memory Access）技术，这些指令将**hello** 中的数据和代码从磁盘复制到内存。
4. CPU执行机器指令，将hello, world，从存中复制到寄存器文件中，再复制到显示器输出给用户。

## 4 存储设备

通常，存储设备容量越大，速度越慢，价格越便宜。存储容量对比如下：

寄存器： 100 ~ 1000B

内存： 1 ~ 100G

磁盘：1 ~ 1000TB

计算机系统的信息存储可以用一个层次结构来表示，通常而言，存储容量越小，速度越快，价格越高，上一层存储设备是下一层存储设备的高速缓存。

![csapp_1_2](C:\Users\lenovo\Desktop\CSAPP\csapp_note\pictures\csapp_1_2.PNG)



处理能力强的处理器一般有3级缓存，L1 缓存和寄存器的速度几乎一样快，大小为KB级，L2的缓存速度是L1的五分之一，大小为数十万到数百万字节，L3容量更大，但是速度更慢。

## 5 操作系统

### 5.1 操作系统的作用

操作系统作为应用程序和硬件间的桥梁，	应用程序不能直接操作硬件，只能通过操作系统。这样设计目的有两个：

（1）防止硬件被失控的应用程序滥用；

（2）操作系统提供统一的机制来控制这些复杂的底层硬件。

为了实现中间件的作用，操作系统引入了文件、虚拟内存、进程三个抽象概念。

文件：对I/O设备的抽象

虚拟内存：对内存和磁盘I/O的抽象

进程：对处理器、内存、I/O设备的抽象

### 5.2 进程

几个重要概念：

上下文：进程运行所需要的所有状态信息，包括当前PC和寄存器的值，以及内存中的内容等等。

多线程：一个进程实际上由多个线程组成，每个线程都运行在进程的上下文中，共享代码和数据。

### 5.3 虚拟内存

操作系统为每个进程提供了一个假象，就是每个进程都在独自占用整个内存空间，每个进程看到的内存都是一样的，我们称之为虚拟地址空间。

下图为linux 虚拟地址空间：

![csapp_1_3](C:\Users\lenovo\Desktop\CSAPP\csapp_note\pictures\csapp_1_3.PNG)

主要包含程序代码和数据、堆、共享区域、用户栈、内核区。

### 5.4 文件

linux系统的哲学思想：一切皆文件。

所有的输入输出设备都可以看成文件，网络也可以视为一个I/O设备，系统的输入输出都是通过文件完成。

## 6 系统加速一些概念

### 6.1 基本概念

任务(task)：并行计算所处理的对象.

工作量(workload)：处理某任务的所需的各种开销的总和

处理器(processor)：并行计算中所使用的最基本的处理器单元

执行率(executionrat)：每个处理器单位时间能完成的工作量

执行时间(executiontime)：处理某任务所需的时间

加速比(scalability)：当处理器个数增多时，完成某固定工作量任务所需执行时间的减少倍数.

理想加速比(idealscalability)：处理器个数增多的比例

并行效率(parallelefficiency):加速比÷理想加速比×100%

### 6.2 三个重要定律

阿姆达尔定律

古斯塔法森定律

孙-倪定律

## 7 并发和并行

线程级并发：增加CPU的核心数，可以提高系统的性能，除此之外，通过超线程技术，例如一个CPU执行两个线程，当一个线程因为读取数据而进入等待状态时，CPU可以去执行另外一个线程，其中线程之间的切换只需要极少的时间代价。

指令级并行：现代处理器可以同时执行多条指令

单指令多数据并行：现代处理器拥有特殊的硬件部件，允许一条指令产生多个并行的操作，这种方式称为单指令多         数据（SingleInstructionMultipleData）





​		